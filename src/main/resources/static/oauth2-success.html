<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OAuth2 Login Success</title>
</head>
<body>
    <p>Login successful. Redirecting...</p>
    <script>
        console.log('OAuth2 Success page loaded');
        console.log('Current URL:', window.location.href);

        // URL에서 'token' 파라미터 값을 추출합니다.
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        console.log('Token from URL:', token);
        console.log('All URL params:', Array.from(urlParams.entries()));

        if (token) {
            console.log('Token found, saving to localStorage');
            // 토큰을 localStorage에 저장합니다. 프론트엔드에서는 이 토큰을 API 요청 시 사용합니다.
            localStorage.setItem('accessToken', token);
            console.log('Token saved, fetching user info to determine redirect');

            // 사용자 정보를 가져와서 역할에 따라 리다이렉트
            fetch('http://localhost:8080/api/auth/me', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                return response.json();
            })
            .then(user => {
                console.log('User info:', user);
                alert('로그인 성공! 환영합니다, ' + user.name + '님!');

                // 역할에 따라 리다이렉트
                if (user.role === 'ADMIN' || user.role === 'SELLER') {
                    console.log('Redirecting to dashboard for ' + user.role);
                    window.location.href = '/dashboard.html';
                } else {
                    console.log('Redirecting to main page for USER');
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Failed to fetch user info:', error);
                alert('사용자 정보를 가져오는데 실패했습니다. 메인 페이지로 이동합니다.');
                window.location.href = '/';
            });
        } else {
            console.log('No token found in URL');
            // 토큰이 없는 경우, 에러 메시지를 표시하고 로그인 페이지로 보냅니다.
            alert('Authentication failed. No token provided. URL: ' + window.location.href);
            window.location.href = '/';
        }
    </script>
</body>
</html>